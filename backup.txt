<!-- ======= FORMULÁR ======= -->
<input id="file" type="file" accept="image/*" multiple>
<button id="uploadBtn" disabled>Nahrať vybrané obrázky</button>
<div id="status"></div>

<!-- ======= SCRIPT ======= -->
<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  /* Všetok kód spustíme až po načítaní DOM-u --------------- */
  window.addEventListener("DOMContentLoaded", () => {
    /* ---------- 1. DOM prvky ---------- */
    const fileInput = document.getElementById("file");
    const uploadBtn = document.getElementById("uploadBtn");
    const statusEl  = document.getElementById("status");

    /* ---------- 2. Supabase klient ---------- */
    const supabase = createClient(
      "https://byowsxlaoljqrbllbiad.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ5b3dzeGxhb2xqcXJibGxiaWFkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMwMzcxNzAsImV4cCI6MjA2ODYxMzE3MH0.dOBoxQqiMBYT5PIbwQUEq-rVBIO5pp1IjG89EO04LD4"
    );

    /* ---------- 3. Získanie QR tokenu ---------- */
    const params   = new URLSearchParams(location.search);
    const qrToken  = params.get("token");
    if (!qrToken) { alert("Nemáš plný prístup na nahrávanie fotiek - oskenuj najbližší QR kód"); return; }

    async function getSignedUrls () {
      const { data, error } = await supabase.functions.invoke("exchange-token", {
        query: { token: qrToken }
      });
      if (error) throw error;
      return data;  // { fileId, original, compressed }
    }

    /* ---------- 4. Povolenie tlačidla po výbere súborov ---------- */
    fileInput.addEventListener("change", () => {
      if (fileInput.files.length > 0) {
        uploadBtn.disabled = false;
        uploadBtn.removeAttribute("disabled");       // <— dôležité
      } else {
        uploadBtn.disabled = true;
        uploadBtn.setAttribute("enabled", "");
      }
    });

    /* ---------- 5. Upload ---------- */
    uploadBtn.addEventListener("click", async () => {
      if (fileInput.files.length === 0) {
        alert("Najprv vyber aspoň jeden obrázok.");  return;
      }

      /* Deaktivuj tlačidlo počas uploadu */
      uploadBtn.disabled = true;
      uploadBtn.setAttribute("disabled", "");
      statusEl.textContent = "Nahrávam obrázky…";

      try {
        for (const file of fileInput.files) {
          if (!file.type.startsWith("image/")) {
            alert(`„${file.name}“ nie je obrázok.`);
            continue;
          }

          const { original } = await getSignedUrls();

          await supabase.storage
            .from("kubko-lenka")
            .uploadToSignedUrl(original.path, original.token, file);
        }

        statusEl.textContent = "✅ Obrázky úspešne nahrané!";
        fileInput.value = "";        // vyčisti vstup, aby event „change“ neskôr opäť zafungoval
      } catch (err) {
        console.error(err);
        alert("Nahrávanie zlyhalo – skús znova.");
        statusEl.textContent = "";
      }
    });
  });
</script> -->