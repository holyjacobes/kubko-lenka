<!doctype html>

<html class="no-js" lang="sk"> 
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <title>Kubko & Lenka sa ber√∫!</title>
    <meta name="description" content="We would like to invite you to our big day.">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#ffffff">
    <meta property="og:title" content="Kubko & Lenka sa ber√∫!">
    <meta property="og:description" content="We would like to invite you to our big day.">
    <meta property="og:image" content="https://wedding.ramswaroop.me/img/header-photo.jpg"> 
    <!-- TODO zmeniy og:image -->
    <meta property="og:type" content="website">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="manifest" href="manifest.json">
    <link rel="mask-icon" href="safari-pinned-tab.svg" color="#5bbad5">

    <script>
        // load css files from CDN if local node_modules fail
        function loadCssFromCDN(css) {
            // create new link tag
            const link = document.createElement('link');
            if (css === 'animate.css') {
                link.href = 'https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.7.2/animate.min.css';
            } else if (css === 'font-awesome.css') {
                link.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css';
            }
            link.rel = 'stylesheet';

            // add link tag to head section
            document.getElementsByTagName('head')[0].appendChild(link);
        }

        // load js files from CDN if local node_modules fail
        function loadJsFromCDN(js) {
            if (js === 'waypoints.js') {
                document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/waypoints/4.0.1/jquery.waypoints.js"><\/script>');
            } else if (js === 'jquery.js') {
                document.write('<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"><\/script>');
            }
        }
    </script>

<!-- CSS files -->
    <link rel="stylesheet" href="css/uploadBtn.css">
    <link rel="stylesheet" href="css/normalize.min.css">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/jquery.fancybox.css">
    <link rel="stylesheet" href="css/flexslider.css">
    <link rel="stylesheet" href="css/styles.min.css">
    <link rel="stylesheet" href="css/queries.css">
    <link rel="stylesheet" href="node_modules/animate.css/animate.min.css" onerror="loadCssFromCDN('animate.css')">
    <link rel="stylesheet" href="node_modules/font-awesome/css/font-awesome.min.css" onerror="loadCssFromCDN('font-awesome.css')">
    <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Pacifico&display=swap" rel="stylesheet">
    <script src="js/vendor/modernizr-2.8.3-respond-1.4.2.min.js"></script>
</head>
<body id="top">


<section class="hero">
    <section class="navigation">
        <header>
            <div class="header-content">
                <div class="logo"><a href="#"><img src="img/logo.png" alt="Logo"></a></div>
                <div class="header-nav">
                    <nav>
                        <ul class="primary-nav">
                            <li><a href="#instagram">Nahra≈• fotky</a></li>
                            <li><a href="#digital-odkaz">Odkaz</a></li>
                            <li><a href="#intro">N√°≈° pr√≠beh</a></li>
                            <li><a href="#events">Harmonogram</a></li>
                        </ul>
                    </nav>
                </div>
                <div class="navicon">
                    <a class="nav-toggle" href="#"><span></span></a>
                </div>
            </div>
        </header>
    </section>
    <div class="container">
        <div class="row">
            <div class="col-md-10 col-md-offset-1">
                <div class="hero-content text-center">
                    <!-- <h1>Lenka & Kubko</h1> -->
                    <img src="img/lenka-kubo-logo-long.png">
                    <p class="intro-extra"> &#x1F493 Vitajte na najsamlep≈°om ve≈°eƒæu &#x1F493 </p>
                    <!-- <a href="#" class="btn btn-fill btn-large btn-margin-right">Scroll Down</a> -->
                </div>
            </div>
        </div>
    </div>
</section>

<!-- <section id="invitation" class="section-padding">
    <div class="container">
        <div class="row">
            <div class="col-md-12 text-center">
                <h3>Berieme sa! Juch√∫√∫!</h3>
            </div>
        </div>
    </div>
</section> -->

<!-- ======= FORMUL√ÅR ======= -->
<section id="instagram" class="section-padding">
    <div class="container">
        <div class="row">
            <div class="col-md-12 text-center">
                <h3> &#x1F4F8 Fotka povie tis√≠c slov</h3>
                <p>Fo≈•te v≈°etko, ƒço sa h√Ωbe (aj to, ƒço nie) a nahrajte nejak√© pekn√© spomienkov√© foteƒçky</p>
            </div>
        </div>
    </div>

    <div class="uploader">
    <!-- skryt√Ω input, sp√∫≈°≈•an√Ω cez label -->
    <input id="file" type="file" accept="image/*" multiple class="visually-hidden">
    
    <div class="actions">
        <label for="file" class="btn outline">Prehƒæad√°va≈•‚Ä¶</label>
        <button id="uploadBtn" class="btn primary" disabled>Nahra≈• vybran√© obr√°zky</button>
    </div>

    <div id="uploadStatus" class="status">Nie s√∫ zvolen√© s√∫bory.</div>
    </div>
</section>

<!-- TODO add github domenu do corsu do supabasu edge funkcie -->

<!-- ======= SCRIPT ======= -->
<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
  import { SUPABASE_URL, ANON_KEY, BUCKET, EXCHANGE_FN } from "./js/app-config.js";

  window.addEventListener("DOMContentLoaded", () => {
    /* ---------- 1. DOM prvky ---------- */
    const fileInput = document.getElementById("file");
    const uploadBtn = document.getElementById("uploadBtn");
    const statusEl  = document.getElementById("uploadStatus");

    function setNone()  { uploadStatus.textContent = "Nie s√∫ zvolen√© s√∫bory."; }
    function setCount(n){ uploadStatus.textContent = n === 1 ? "Vybran√Ω 1 s√∫bor." : `Vybran√© ${n} s√∫bory.`; }
    function disableBtn(){ uploadBtn.disabled = true;  uploadBtn.setAttribute("disabled",""); }
    function enableBtn(){  uploadBtn.disabled = false; uploadBtn.removeAttribute("disabled"); }

    function refreshUI() {  // <‚Äî volaj v≈ædy, keƒè sa m√¥≈æe zmeni≈• poƒçet
      const n = fileInput.files?.length || 0;
      if (n > 0) { enableBtn(); setCount(n); }
      else       { disableBtn(); setNone(); }
    }

    fileInput.addEventListener("change", refreshUI);    // <‚Äî aktualizuje text hneƒè po v√Ωbere
    refreshUI();              // <‚Äî inicializ√°cia pri ≈°tarte


    /* ---------- 2. Kon≈°tanty ---------- */
    // const SUPABASE_URL = "https://byowsxlaoljqrbllbiad.supabase.co";
    // const ANON_KEY     = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ5b3dzeGxhb2xqcXJibGxiaWFkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMwMzcxNzAsImV4cCI6MjA2ODYxMzE3MH0.dOBoxQqiMBYT5PIbwQUEq-rVBIO5pp1IjG89EO04LD4";
    // const BUCKET       = "kubko-lenka";

    /* ---------- 3. Public klient (na volanie edge funkcie) ---------- */
    const supabasePublic = createClient(SUPABASE_URL, ANON_KEY);

    /* ---------- 4. QR token z URL ---------- */
    const params  = new URLSearchParams(location.search);
    const qrToken = params.get("token");
    if (!qrToken) {
      alert("Nem√°≈° pln√Ω pr√≠stup na nahr√°vanie fotiek - oskenuj najbli≈æ≈°√≠ QR k√≥d");
      return;
    }

    /* ---------- 5. Zabezpeƒçen√Ω klient s JWT (Bearer) ---------- */
    let supabaseJwt = null; // cache klienta s kr√°tkodob√Ωm JWT

    async function getJwtClient(forceRefresh = false) {
      if (supabaseJwt && !forceRefresh) return supabaseJwt;

      const { data, error } = await supabasePublic.functions.invoke(`exchange-token?token=${encodeURIComponent(qrToken)}`);
      if (error || !data?.access_token) {
        throw new Error(error?.message || "Token exchange failed");
      }

      supabaseJwt = createClient(SUPABASE_URL, ANON_KEY, {
        global: { headers: { Authorization: `Bearer ${data.access_token}` } }
      });
      return supabaseJwt;
    }

    /* ---------- 6. UI pomocn√© funkcie ---------- */
    function updateButtonState() {
      if (fileInput.files && fileInput.files.length > 0) {
        uploadBtn.disabled = false;
        uploadBtn.removeAttribute("disabled");
      } else {
        uploadBtn.disabled = true;
        uploadBtn.setAttribute("disabled", "");
      }
    }
    fileInput.addEventListener("change", updateButtonState);

    function isLikelyImage(file) {
      return file && file.type && file.type.startsWith("image/");
    }
    function safeName(name) {
      return name.toLowerCase().replace(/[^a-z0-9._-]+/g, "_").slice(0, 80);
    }
    function buildOriginalPath(file) {
      const ts  = Date.now();
      const rnd = Math.random().toString(36).slice(2, 8);
      return `original/${ts}-${rnd}-${safeName(file.name)}`;
    }

    /* ---------- 7. Upload ---------- */
    uploadBtn.addEventListener("click", async () => {
      if (!fileInput.files || fileInput.files.length === 0) {
        alert("Najprv vyber aspo≈à jeden obr√°zok.");
        return;
      }

      uploadBtn.disabled = true;
      uploadBtn.setAttribute("disabled", "");
      statusEl.textContent = "Nahr√°vam obr√°zky‚Ä¶ M√¥≈æe to chv√≠ƒæu trva≈• :)";

      try {
        let client = await getJwtClient();

        for (const file of fileInput.files) {
          if (!isLikelyImage(file)) {
            alert(`‚Äû${file.name}‚Äú nie je obr√°zok.`);
            continue;
          }

          const path = buildOriginalPath(file);

          // Prv√Ω pokus o upload s aktu√°lnym JWT
          let { error } = await client.storage.from(BUCKET).upload(path, file, {
            upsert: false,
            cacheControl: "3600",
            contentType: file.type || "application/octet-stream"
          });

          // Ak by JWT medziƒçasom expiroval ‚Üí refre≈°ni a sk√∫s znova
          if (error && (error.statusCode === 401 || error.statusCode === 403)) {
            client = await getJwtClient(true);
            ({ error } = await client.storage.from(BUCKET).upload(path, file, {
              upsert: false,
              cacheControl: "3600",
              contentType: file.type || "application/octet-stream"
            }));
          }

          if (error) {
            console.error("Upload error:", error);
            alert(`Upload zlyhal pre ‚Äû${file.name}‚Äú. (${error.message || error})`);
          }
        }

        statusEl.textContent = "‚úÖ Obr√°zky √∫spe≈°ne nahran√©!";
        fileInput.value = "";        // resetni input
        updateButtonState();         // znovu zak√°≈æ tlaƒçidlo, k√Ωm nevyber√∫ ƒèal≈°ie s√∫bory
      } catch (err) {
        console.error(err);
        alert("Nahr√°vanie zlyhalo ‚Äì sk√∫s znova.");
        statusEl.textContent = "";
      }
    });
  });
</script>

<!-- NAHRAVANIE -->
<!-- GAL√âRIA -->
<div id="status" style="margin:.5rem 0;color:#666">Naƒç√≠tavam fotky‚Ä¶</div>
<div id="gallery" style="
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
  gap:12px;
"></div>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
  import { SUPABASE_URL, ANON_KEY, BUCKET, EXCHANGE_FN } from "./js/app-config.js";

  const supabase = createClient(SUPABASE_URL, ANON_KEY);

  const statusEl = document.getElementById("status");
  const gallery  = document.getElementById("gallery");

  function renderPhotos(urls = []) {
    gallery.innerHTML = "";
    if (!urls.length) {
      statusEl.textContent = "Zatiaƒæ tu nie s√∫ ≈æiadne fotky.";
      return;
    }
    statusEl.textContent = "";
    for (const url of urls) {
      const img = document.createElement("img");
      img.src = url;
      img.loading = "lazy";
      img.decoding = "async";
      img.alt = "Svadobn√° fotka";
      img.style.width = "100%";
      img.style.height = "auto";
      img.style.borderRadius = "8px";
      img.referrerPolicy = "no-referrer"; // len pre istotu
      gallery.appendChild(img);
    }
  }

  async function loadRandomPhotos() {
    try {
      const params  = new URLSearchParams(location.search);
      const qrToken = params.get("token");
      if (!qrToken) {
        statusEl.textContent = "Ch√Ωba pr√≠stupov√Ω token ‚Äì oskenuj QR k√≥d.";
        return;
      }

      // D√¥le≈æit√©: posielame token v QUERY STRINGU
      const { data, error } = await supabase.functions.invoke(
        `random-photos?token=${encodeURIComponent(qrToken)}`
      );

      if (error) {
        console.error(error);
        statusEl.textContent = "Nepodarilo sa naƒç√≠ta≈• fotky.";
        return;
      }

      const urls = (data?.photos || [])
        .filter(p => p.url)
        .map(p => p.url);

      renderPhotos(urls);
    } catch (e) {
      console.error(e);
      statusEl.textContent = "Nastala chyba pri naƒç√≠tan√≠ fotiek.";
    }
  }

  // Auto-load po naƒç√≠tan√≠ DOMu
  window.addEventListener("DOMContentLoaded", loadRandomPhotos);
</script>


<!-- ======= DIGIT√ÅLNY ODKAZ ======= -->
<section id="digital-odkaz" class="section-padding">
  <div class="container">
    <div class="row">
      <div class="col-md-12 text-center">
        <h3>üíå Zanechaj n√°m digit√°lny odkaz</h3>
        <p>Chce≈° n√°m nieƒço odk√°za≈•? Sem s t√Ωm!</p>
      </div>
    </div>

    <form id="odkazForm" class="odkaz-form" style="max-width:680px;margin:0 auto" novalidate>
      <div class="form-group">
        <label for="odkazName">Meno (nepovinn√©)</label>
        <input id="odkazName" class="form-control" type="text" maxlength="120" placeholder="Tvoje meno">
      </div>

      <div class="form-group">
        <label for="odkazMessage">Odkaz</label>
        <textarea id="odkazMessage" class="form-control" rows="5" maxlength="10000" required
          placeholder="Nap√≠≈° odkaz pre novoman≈æelov‚Ä¶"></textarea>
        <small id="odkazCounter" class="help-block" style="display:block;margin-top:4px;">0 / 10 000</small>
      </div>

      <button id="odkazSubmit" type="submit" class="btn primary">Odosla≈• odkaz</button>
      <div id="odkazStatus" style="margin-top:.5rem;color:#666"></div>
    </form>
  </div>
</section>

<section id="intro">
    <div class="container">
        <div class="row">
            <div class="col-md-12 text-center">
                <h2 class="header">N√°≈° pr√≠beh</h2>
            </div>
        </div>
        <div class="row">
            <div class="col-md-3 hidden-sm hidden-xs"><img src="img/IMG_cropped_tog1.jpg" class="wp1"></div>
            <div class="col-md-6">
                          <!-- LENKA PRIBEH -->
            <div class="col-md-6">
                <h4 class="col-md-12 text-center" class="header"><strong>Pr√≠beh podƒæa Lenky</strong></h4>
                <p>
Vianoce 2018‚Ä¶ Pam√§t√°m si ich veƒæmi dobre. Po dlh≈°om ƒçase som bola koneƒçne doma, keƒè≈æe som v roku 2016 odcestovala do √çrska a toto boli moje prv√© sviatky, ktor√© som mohla po dvoch rokoch str√°vi≈• s rodinou. Ja, moje sestry a kamo≈°ka sme mali, ako v≈ædy, pln√∫ hlavu pl√°nov ‚Äì koho stretneme, kam p√¥jdeme, ƒço v≈°etko stihnem. No a pr√°ve poƒças jedn√©ho z t√Ωchto na≈°ich veƒçerov sa stalo nieƒço, ƒço √∫plne zmenilo m√¥j ≈æivot.                </p>
                                <p>
Vybrali sme sa do vtedaj≈°ieho baru Insomnia v ≈Ωupƒçanoch. Sedeli sme, smiali sa, rozoberali ≈æivot a v≈°etko mo≈æn√©, keƒè z vedƒæaj≈°ieho stola sa ozvalo:<br>
<b>‚ÄûBaby, nepripijeme si spolu?‚Äú</b><br>
Pozrela som t√Ωm smerom a tam sedel veƒæmi sympatick√Ω a pekn√Ω chalan ‚Äì Jakub. U≈æ som ho tro≈°ku poznala ako kamo≈°a mojej sestry a pam√§t√°m si, ≈æe som jej raz povedala: ‚ÄûTen chalan je  velmi pekn√Ω!‚Äú Tak≈æe keƒè sa k n√°m chcel prida≈•, ja som neprotestovala ‚Äì pr√°ve naopak, te≈°ila som sa.                 </p>
                                                
                                                  <p>Veƒçer sa niesol v znamen√≠ smiechu, rozhovorov a postupne sme si padli do oka. No a ako to u≈æ b√Ωva, noc sa neskonƒçila len v√≠nom a reƒçami ‚Äì ocitli sme sa spolu na parkete v bare Aqua Belly a tancovali sme pri akv√°riu plnom rybiƒçiek. </p>
<p>R√°no bolo mierne tr√°pne. Teda aspo≈à pre m≈àa. Tro≈°ku som sa hanbila, ƒçakala som, ƒço bude ƒèalej. A potom, okolo obeda, mi od Jakuba pri≈°la spr√°va:<br>
<b>‚ÄûAhoj, ≈æije≈°?‚Äú</b>
                                                                <p>
Odvtedy sme si zaƒçali p√≠sa≈• ka≈æd√Ω de≈à. Do konca sviatkov sme sa e≈°te p√°rkr√°t stretli a jedn√©ho veƒçera mi Jakub povedal vetu, ktor√∫ som vtedy brala len ako ≈æart:
‚ÄûJa za tebou pr√≠dem do √çrska.‚Äú
No a on to fakt urobil.                </p>
<p>Po p√°r mesiacoch naozaj pri≈°iel. A odvtedy je po mojom boku. M√¥j Jakub z neba. </p>
            </div>

                <h4 class="col-md-12 text-center" class="header"><strong>Pr√≠beh podƒæa Kuba</strong></h4>
                <p>
December 2019, pekn√© vianky ale ja zniƒçen√Ω vysokou ≈°kolou, preto≈æe som z√≠skal ultim√°tny vysoko≈°kolsk√Ω √∫spech DVD - Do Vianoc Doma, nafurt.
                </p>

                                <p>
Pre≈°iel ≈°tedr√Ω de≈à, pri≈°lo 25. decembra a keƒè≈æe som bol nezamestnan√Ω a v podstate ne≈°tudent, vybral som sa s partiou do ≈Ωupƒçanskej krƒçmiƒçky. A tam hƒæa, pri vedƒæaj≈°om stole pekn√° blond√≠nka, pop√≠ja fernet s kolou a u≈æ√≠va si Vianoƒçn√∫ dovolenku.
Slovo dalo slovo a u≈æ sme sedeli pri jednom stole, vymienali historky a plnili krƒçmov√∫ kasiƒçku. Ale Lenka za p√°r dni odch√°dzala do √çrska. Ale keƒè≈æe m√°me √∫≈æasn√∫ dobu mesend≈æeru a mal som kopec voƒæn√©ho ƒçasu, nonstop sme si p√≠sali.
V marci pri≈°la Lenka na dovolenku, veƒè ma predsa chcela vidie≈• :) Vtedy som jej povedal, ≈æe za ≈àou pr√≠dem do √çrska, Lenka sa zasmiala a ja som zaƒçal ku≈• pl√°ny do bud√∫cnosti. 
                </p>
                                                <p>
≈†etril som a priplazil sa november, k√∫pil som letenky, pobalil t√Ωch 7 triƒçiek ktor√© som mal, pok√Ωval som a hur√° za nov√Ωm dobrodru≈æstvom. Keƒè≈æe tam Lenka ≈æila aj s Pa≈•ou a Simonou, hƒæadali sme nov√© v√§ƒç≈°ie b√Ωvanie, prv√© dni sme spali na matraci a u≈æ√≠vali ≈æivot. 
Ledva som si na≈°iel robotu a zrazu korona. A znova sme si u≈æ√≠vali, ƒço to ≈°lo. Jedn√° vlna, druh√° vlna, tretia vlna, medzit√Ωm po roku a pol nez√°≈æivn√° robota a mne zrazu zaƒçalo nieƒço ch√Ωba≈• (asi slnko, keƒè≈æe vo Febru√°ri 2021 len pr≈°alo a pr≈°alo).
Pocit, ≈æe to chce znova zmenu, chcem √≠s≈• sp√§≈• na V≈†. Lenka nev√°hala ani sekundu, hovor√≠ ≈æe ide somnou, najsamlep≈°ie rozhodnutie <span class="fa fa-heart pulse2"></span>. 
                </p>
                                                                <p>
ƒéal≈°ie roky boli pln√© driny a z√°≈æitkov, samostatn√© b√Ωvanie, prer√°bka n√°≈°ho skromn√©ho pr√≠bytku, nespoƒçet osl√°v, sk√∫≈°kov√©, v√Ωlety, h√°dky, no proste All Inclusive.  Kto mal na zaƒçiatku tu≈°i≈•, ≈æe o 6 rokov bude ve≈°eƒæe?
                </p>
            </div>
            <div class="col-md-3 hidden-sm hidden-xs"><img src="img/IMG_cropped_tog2.png" class="wp2"></div>
        </div>
        <div class="row">
            <div class="col-sm-4 col-sm-push-2 col-xs-6 hidden-md hidden-lg"><img src="img/IMG_cropped_tog1.jpg" class="wp8"></div>

            <!-- <div class="col-sm-4 col-sm-push-2 col-xs-6 hidden-md hidden-lg"><img src="img/IMG_2317.jpg" class="wp8"></div> -->
            <div class="col-sm-4 col-sm-push-2 col-xs-6 hidden-md hidden-lg"><img src="img/IMG_cropped_tog2.png" class="wp9"></div>
        </div>
    </div>
</section>

<!-- TODO celu tuto sekciu vymysliet! -->
<section class="events section-padding" id="events">
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <h3 class="header">Events</h3>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6 col-sm-12 col-xs-12 leftcol">
                <div class="wp3">
                    <p><strong>22 August</strong></p>

                    <h5>Obrad <span class="time"> 14:30 - 15:30</span></h5>
                    <p>Tu si povieme svoje √°no &#129505</p>
                </div>
            </div>
            <div class="col-md-6 col-sm-12 col-xs-12 leftcol">
                <div class="wp3">
                    <h5>Teleport√°cia <span class="time"> 15:30 - 16:30</span></h5>
                    <p>Smer Stodolienka u Hricka, Hanu≈°ovce nad Topƒæou</p>
                </div>
            </div>
            <div class="col-md-6 col-sm-12 col-xs-12 leftcol">
                <div class="wp4">
                    <h5>Hostina <span class="time"> 16:30 - 03:00</span></h5>
                    <p>Papanie a oslavovanie</p>
                    <div class="tenor-gif-embed" data-postid="14307475070394584011" data-share-method="host" data-aspect-ratio="0.564171" data-width="100%"><a href="https://tenor.com/view/cat-dancing-to-party-rock-anthem-gif-14307475070394584011">Cat Dancing To Party Rock Anthem GIF</a>from <a href="https://tenor.com/search/cat+dancing+to+party+rock+anthem-gifs">Cat Dancing To Party Rock Anthem GIFs</a></div> <script type="text/javascript" async src="https://tenor.com/embed.js"></script>
                </div>
            </div>
        </div>

    </div>
</section>

<footer>
    <div class="container">
        <div class="row">
            <div class="col-sm-12 text-center content">
                <span class="to-top-wrapper"><a href="#top" class="to-top"><i class="fa fa-angle-up"></i></a></span>
                <p>Crafted by Kubko with lots of <span class="fa fa-heart pulse2"></span> for Lenka</p>
            </div>
        </div>
    </div>
</footer>
<script src="js/vendor/jquery-1.11.2.min.js" onerror="loadJsFromCDN('jquery.js')"></script>
<script src="node_modules/waypoints/lib/jquery.waypoints.min.js" onerror="loadJsFromCDN('waypoints.js')"></script>
<script src="js/jquery.fancybox.pack.js"></script>
<script src="js/vendor/bootstrap.min.js"></script>
<script src="js/jquery.flexslider-min.js"></script>
<script src="js/jquery.mb.YTPlayer.min.js"></script>
<script src="js/vendor/ouical.js"></script>
<script src="js/scripts.min.js"></script>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
  import { SUPABASE_URL, ANON_KEY, BUCKET, EXCHANGE_FN } from "./js/app-config.js";

  // --- Zdieƒæan√Ω helper: vy≈æiadanie kr√°tkodob√©ho JWT cez tvoj exchange-token
  let supabaseJwt = null;

  async function getJwtClient(forceRefresh = false) {
    if (supabaseJwt && !forceRefresh) return supabaseJwt;

    const supabasePublic = createClient(SUPABASE_URL, ANON_KEY);

    const params  = new URLSearchParams(location.search);
    const qrToken = params.get("token");
    if (!qrToken) {
      throw new Error("Ch√Ωba pr√≠stupov√Ω token ‚Äì oskenuj QR k√≥d.");
    }

    // D√îLE≈ΩIT√â: token posielame v query stringu (ako u≈æ pou≈æ√≠va≈° inde)
    const { data, error } = await supabasePublic.functions.invoke(
      `exchange-token?token=${encodeURIComponent(qrToken)}`
    );
    if (error || !data?.access_token) {
      throw new Error(error?.message || "Token exchange failed");
    }

    supabaseJwt = createClient(SUPABASE_URL, ANON_KEY, {
      global: { headers: { Authorization: `Bearer ${data.access_token}` } }
    });
    return supabaseJwt;
  }

  // --- DOM prvky
  const form    = document.getElementById("odkazForm");
  const nameEl  = document.getElementById("odkazName");
  const msgEl   = document.getElementById("odkazMessage");
  const counter = document.getElementById("odkazCounter");
  const status  = document.getElementById("odkazStatus");
  const btn     = document.getElementById("odkazSubmit");

  // --- UX: live poƒç√≠tadlo znakov + zapni/vypni tlaƒçidlo
  const LIMIT = 10000;
  function updateCounter() {
    const len = (msgEl.value || "").length;
    counter.textContent = `${len} / ${LIMIT}`;
    if (len === 0 || len > LIMIT) {
      btn.setAttribute("disabled", "");
    } else {
      btn.removeAttribute("disabled");
    }
  }
  msgEl.addEventListener("input", updateCounter);
  updateCounter();

  function setStatus(text, ok = true) {
    status.textContent = text;
    status.style.color = ok ? "#2e7d32" : "#c62828";
  }

  // --- Submit handler
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    setStatus("");

    const name    = (nameEl.value || "").trim();
    const message = (msgEl.value || "").trim();

    if (!message) {
      setStatus("Nap√≠≈° pros√≠m odkaz üòä", false);
      return;
    }
    if (message.length > LIMIT) {
      setStatus("Odkaz je pr√≠li≈° dlh√Ω (max. 10 000 znakov).", false);
      return;
    }

    btn.setAttribute("disabled", "");
    setStatus("Odosielam‚Ä¶");

    // Zabali≈• volanie na edge funkciu + 1x retry pri expirovanom JWT
    async function callSubmit(client) {
      return client.functions.invoke("submit-odkaz", { body: { name, message } });
    }

    try {
      let client = await getJwtClient();
      let { data, error } = await callSubmit(client);

      // Ak by JWT medzit√Ωm expiroval ‚Üí obnov a sk√∫s znova
      if ((error && (error.status === 401 || error.status === 403)) || (data && data.error === "JWT expired")) {
        client = await getJwtClient(true);
        ({ data, error } = await callSubmit(client));
      }

      if (error || data?.error) {
        setStatus(data?.error || error?.message || "Nepodarilo sa odosla≈• odkaz.", false);
        return;
      }

      // √öspech
      setStatus("‚úÖ ƒéakujeme!");
      form.reset();
      updateCounter();

      // BONUS UX: predvypl≈à meno nabud√∫ce (lok√°lne)
      if (name) {
        try { localStorage.setItem("odkaz_name", name); } catch {}
      }
    } catch (err) {
      console.error(err);
      setStatus("Chyba pri odosielan√≠. Sk√∫s to pros√≠m znova.", false);
    } finally {
      btn.removeAttribute("disabled");
    }
  });

  // Predvypl≈à meno, ak sme si ho ulo≈æili
  try {
    const saved = localStorage.getItem("odkaz_name");
    if (saved) { nameEl.value = saved; }
  } catch {}
</script>


</body>
</html>



