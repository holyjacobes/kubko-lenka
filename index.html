<!doctype html>

<html class="no-js" lang="sk"> 
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <title>Kubko & Lenka sa berú!</title>
    <meta name="description" content="We would like to invite you to our big day.">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#ffffff">
    <meta property="og:title" content="Kubko & Lenka sa berú!">
    <meta property="og:description" content="We would like to invite you to our big day.">
    <meta property="og:image" content="https://wedding.ramswaroop.me/img/header-photo.jpg"> 
    <!-- TODO zmeniy og:image -->
    <meta property="og:type" content="website">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="manifest" href="manifest.json">
    <link rel="mask-icon" href="safari-pinned-tab.svg" color="#5bbad5">

    <script>
        // load css files from CDN if local node_modules fail
        function loadCssFromCDN(css) {
            // create new link tag
            const link = document.createElement('link');
            if (css === 'animate.css') {
                link.href = 'https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.7.2/animate.min.css';
            } else if (css === 'font-awesome.css') {
                link.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css';
            }
            link.rel = 'stylesheet';

            // add link tag to head section
            document.getElementsByTagName('head')[0].appendChild(link);
        }

        // load js files from CDN if local node_modules fail
        function loadJsFromCDN(js) {
            if (js === 'waypoints.js') {
                document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/waypoints/4.0.1/jquery.waypoints.js"><\/script>');
            } else if (js === 'jquery.js') {
                document.write('<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"><\/script>');
            }
        }
    </script>

<!-- CSS files -->
    <link rel="stylesheet" href="css/uploadBtn.css">
    <link rel="stylesheet" href="css/normalize.min.css">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/jquery.fancybox.css">
    <link rel="stylesheet" href="css/flexslider.css">
    <link rel="stylesheet" href="css/styles.min.css">
    <link rel="stylesheet" href="css/queries.css">
    <link rel="stylesheet" href="node_modules/animate.css/animate.min.css" onerror="loadCssFromCDN('animate.css')">
    <link rel="stylesheet" href="node_modules/font-awesome/css/font-awesome.min.css" onerror="loadCssFromCDN('font-awesome.css')">
    <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Pacifico&display=swap" rel="stylesheet">
    <script src="js/vendor/modernizr-2.8.3-respond-1.4.2.min.js"></script>
</head>
<body id="top">


<section class="hero">
    <section class="navigation">
        <header>
            <div class="header-content">
                <div class="logo"><a href="#"><img src="img/logo.png" alt="Logo"></a></div>
                <div class="header-nav">
                    <nav>
                        <ul class="primary-nav">
                            <li><a href="#instagram">Nahrať fotky</a></li>
                            <li><a href="#digital-odkaz">Odkaz</a></li>
                            <li><a href="#intro">Náš príbeh</a></li>
                            <li><a href="#events">Harmonogram</a></li>
                        </ul>
                    </nav>
                </div>
                <div class="navicon">
                    <a class="nav-toggle" href="#"><span></span></a>
                </div>
            </div>
        </header>
    </section>
    <div class="container">
        <div class="row">
            <div class="col-md-10 col-md-offset-1">
                <div class="hero-content text-center">
                    <!-- <h1>Lenka & Kubko</h1> -->
                    <img src="img/lenka-kubo-logo-long.png">
                    <p class="intro-extra"> &#x1F493 Vitajte na najsamlepšom vešeľu &#x1F493 </p>
                    <!-- <a href="#" class="btn btn-fill btn-large btn-margin-right">Scroll Down</a> -->
                </div>
            </div>
        </div>
    </div>
</section>

<!-- <section id="invitation" class="section-padding">
    <div class="container">
        <div class="row">
            <div class="col-md-12 text-center">
                <h3>Berieme sa! Juchúú!</h3>
            </div>
        </div>
    </div>
</section> -->

<!-- ======= FORMULÁR ======= -->
<section id="instagram" class="section-padding">
    <div class="container">
        <div class="row">
            <div class="col-md-12 text-center">
                <h3> &#x1F4F8 Fotka povie tisíc slov</h3>
                <p>Foťte všetko, čo sa hýbe (aj to, čo nie) a nahrajte nejaké pekné spomienkové fotečky</p>
            </div>
        </div>
    </div>

    <div class="uploader">
    <!-- skrytý input, spúšťaný cez label -->
    <input id="file" type="file" accept="image/*" multiple class="visually-hidden">
    
    <div class="actions">
        <label for="file" class="btn outline">Prehľadávať…</label>
        <button id="uploadBtn" class="btn primary" disabled>Nahrať vybrané obrázky</button>
    </div>

    <div id="uploadStatus" class="status">Nie sú zvolené súbory.</div>
    </div>
</section>

<!-- TODO add github domenu do corsu do supabasu edge funkcie -->

<!-- ======= SCRIPT ======= -->
<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
  import { SUPABASE_URL, ANON_KEY, BUCKET, EXCHANGE_FN } from "./js/app-config.js";

  window.addEventListener("DOMContentLoaded", () => {
    /* ---------- 1. DOM prvky ---------- */
    const fileInput = document.getElementById("file");
    const uploadBtn = document.getElementById("uploadBtn");
    const statusEl  = document.getElementById("uploadStatus");

    function setNone()  { uploadStatus.textContent = "Nie sú zvolené súbory."; }
    function setCount(n){ uploadStatus.textContent = n === 1 ? "Vybraný 1 súbor." : `Vybrané ${n} súbory.`; }
    function disableBtn(){ uploadBtn.disabled = true;  uploadBtn.setAttribute("disabled",""); }
    function enableBtn(){  uploadBtn.disabled = false; uploadBtn.removeAttribute("disabled"); }

    function refreshUI() {  // <— volaj vždy, keď sa môže zmeniť počet
      const n = fileInput.files?.length || 0;
      if (n > 0) { enableBtn(); setCount(n); }
      else       { disableBtn(); setNone(); }
    }

    fileInput.addEventListener("change", refreshUI);    // <— aktualizuje text hneď po výbere
    refreshUI();              // <— inicializácia pri štarte


    /* ---------- 2. Konštanty ---------- */
    // const SUPABASE_URL = "https://byowsxlaoljqrbllbiad.supabase.co";
    // const ANON_KEY     = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ5b3dzeGxhb2xqcXJibGxiaWFkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMwMzcxNzAsImV4cCI6MjA2ODYxMzE3MH0.dOBoxQqiMBYT5PIbwQUEq-rVBIO5pp1IjG89EO04LD4";
    // const BUCKET       = "kubko-lenka";

    /* ---------- 3. Public klient (na volanie edge funkcie) ---------- */
    const supabasePublic = createClient(SUPABASE_URL, ANON_KEY);

    /* ---------- 4. QR token z URL ---------- */
    const params  = new URLSearchParams(location.search);
    const qrToken = params.get("token");
    if (!qrToken) {
      alert("Nemáš plný prístup na nahrávanie fotiek - oskenuj najbližší QR kód");
      return;
    }

    /* ---------- 5. Zabezpečený klient s JWT (Bearer) ---------- */
    let supabaseJwt = null; // cache klienta s krátkodobým JWT

    async function getJwtClient(forceRefresh = false) {
      if (supabaseJwt && !forceRefresh) return supabaseJwt;

      const { data, error } = await supabasePublic.functions.invoke(`exchange-token?token=${encodeURIComponent(qrToken)}`);
      if (error || !data?.access_token) {
        throw new Error(error?.message || "Token exchange failed");
      }

      supabaseJwt = createClient(SUPABASE_URL, ANON_KEY, {
        global: { headers: { Authorization: `Bearer ${data.access_token}` } }
      });
      return supabaseJwt;
    }

    /* ---------- 6. UI pomocné funkcie ---------- */
    function updateButtonState() {
      if (fileInput.files && fileInput.files.length > 0) {
        uploadBtn.disabled = false;
        uploadBtn.removeAttribute("disabled");
      } else {
        uploadBtn.disabled = true;
        uploadBtn.setAttribute("disabled", "");
      }
    }
    fileInput.addEventListener("change", updateButtonState);

    function isLikelyImage(file) {
      return file && file.type && file.type.startsWith("image/");
    }
    function safeName(name) {
      return name.toLowerCase().replace(/[^a-z0-9._-]+/g, "_").slice(0, 80);
    }
    function buildOriginalPath(file) {
      const ts  = Date.now();
      const rnd = Math.random().toString(36).slice(2, 8);
      return `original/${ts}-${rnd}-${safeName(file.name)}`;
    }

    /* ---------- 7. Upload ---------- */
    uploadBtn.addEventListener("click", async () => {
      if (!fileInput.files || fileInput.files.length === 0) {
        alert("Najprv vyber aspoň jeden obrázok.");
        return;
      }

      uploadBtn.disabled = true;
      uploadBtn.setAttribute("disabled", "");
      statusEl.textContent = "Nahrávam obrázky… Môže to chvíľu trvať :)";

      try {
        let client = await getJwtClient();

        for (const file of fileInput.files) {
          if (!isLikelyImage(file)) {
            alert(`„${file.name}“ nie je obrázok.`);
            continue;
          }

          const path = buildOriginalPath(file);

          // Prvý pokus o upload s aktuálnym JWT
          let { error } = await client.storage.from(BUCKET).upload(path, file, {
            upsert: false,
            cacheControl: "3600",
            contentType: file.type || "application/octet-stream"
          });

          // Ak by JWT medzičasom expiroval → refrešni a skús znova
          if (error && (error.statusCode === 401 || error.statusCode === 403)) {
            client = await getJwtClient(true);
            ({ error } = await client.storage.from(BUCKET).upload(path, file, {
              upsert: false,
              cacheControl: "3600",
              contentType: file.type || "application/octet-stream"
            }));
          }

          if (error) {
            console.error("Upload error:", error);
            alert(`Upload zlyhal pre „${file.name}“. (${error.message || error})`);
          }
        }

        statusEl.textContent = "✅ Obrázky úspešne nahrané!";
        fileInput.value = "";        // resetni input
        updateButtonState();         // znovu zakáž tlačidlo, kým nevyberú ďalšie súbory
      } catch (err) {
        console.error(err);
        alert("Nahrávanie zlyhalo – skús znova.");
        statusEl.textContent = "";
      }
    });
  });
</script>

<!-- NAHRAVANIE -->
<!-- GALÉRIA -->
<div id="status" style="margin:.5rem 0;color:#666">Načítavam fotky…</div>
<div id="gallery" style="
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
  gap:12px;
"></div>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
  import { SUPABASE_URL, ANON_KEY, BUCKET, EXCHANGE_FN } from "./js/app-config.js";

  const supabase = createClient(SUPABASE_URL, ANON_KEY);

  const statusEl = document.getElementById("status");
  const gallery  = document.getElementById("gallery");

  function renderPhotos(urls = []) {
    gallery.innerHTML = "";
    if (!urls.length) {
      statusEl.textContent = "Zatiaľ tu nie sú žiadne fotky.";
      return;
    }
    statusEl.textContent = "";
    for (const url of urls) {
      const img = document.createElement("img");
      img.src = url;
      img.loading = "lazy";
      img.decoding = "async";
      img.alt = "Svadobná fotka";
      img.style.width = "100%";
      img.style.height = "auto";
      img.style.borderRadius = "8px";
      img.referrerPolicy = "no-referrer"; // len pre istotu
      gallery.appendChild(img);
    }
  }

  async function loadRandomPhotos() {
    try {
      const params  = new URLSearchParams(location.search);
      const qrToken = params.get("token");
      if (!qrToken) {
        statusEl.textContent = "Chýba prístupový token – oskenuj QR kód.";
        return;
      }

      // Dôležité: posielame token v QUERY STRINGU
      const { data, error } = await supabase.functions.invoke(
        `random-photos?token=${encodeURIComponent(qrToken)}`
      );

      if (error) {
        console.error(error);
        statusEl.textContent = "Nepodarilo sa načítať fotky.";
        return;
      }

      const urls = (data?.photos || [])
        .filter(p => p.url)
        .map(p => p.url);

      renderPhotos(urls);
    } catch (e) {
      console.error(e);
      statusEl.textContent = "Nastala chyba pri načítaní fotiek.";
    }
  }

  // Auto-load po načítaní DOMu
  window.addEventListener("DOMContentLoaded", loadRandomPhotos);
</script>


<!-- ======= DIGITÁLNY ODKAZ ======= -->
<section id="digital-odkaz" class="section-padding">
  <div class="container">
    <div class="row">
      <div class="col-md-12 text-center">
        <h3>💌 Zanechaj nám digitálny odkaz</h3>
        <p>Chceš nám niečo odkázať? Sem s tým!</p>
      </div>
    </div>

    <form id="odkazForm" class="odkaz-form" style="max-width:680px;margin:0 auto" novalidate>
      <div class="form-group">
        <label for="odkazName">Meno (nepovinné)</label>
        <input id="odkazName" class="form-control" type="text" maxlength="120" placeholder="Tvoje meno">
      </div>

      <div class="form-group">
        <label for="odkazMessage">Odkaz</label>
        <textarea id="odkazMessage" class="form-control" rows="5" maxlength="10000" required
          placeholder="Napíš odkaz pre novomanželov…"></textarea>
        <small id="odkazCounter" class="help-block" style="display:block;margin-top:4px;">0 / 10 000</small>
      </div>

      <button id="odkazSubmit" type="submit" class="btn primary">Odoslať odkaz</button>
      <div id="odkazStatus" style="margin-top:.5rem;color:#666"></div>
    </form>
  </div>
</section>

<section id="intro">
    <div class="container">
        <div class="row">
            <div class="col-md-12 text-center">
                <h2 class="header">Náš príbeh</h2>
            </div>
        </div>
        <div class="row">
            <div class="col-md-3 hidden-sm hidden-xs"><img src="img/IMG_cropped_tog1.jpg" class="wp1"></div>
            <div class="col-md-6">
                          <!-- LENKA PRIBEH -->
            <div class="col-md-6">
                <h4 class="col-md-12 text-center" class="header"><strong>Príbeh podľa Lenky</strong></h4>
                <p>
Vianoce 2018… Pamätám si ich veľmi dobre. Po dlhšom čase som bola konečne doma, keďže som v roku 2016 odcestovala do Írska a toto boli moje prvé sviatky, ktoré som mohla po dvoch rokoch stráviť s rodinou. Ja, moje sestry a kamoška sme mali, ako vždy, plnú hlavu plánov – koho stretneme, kam pôjdeme, čo všetko stihnem. No a práve počas jedného z týchto našich večerov sa stalo niečo, čo úplne zmenilo môj život.                </p>
                                <p>
Vybrali sme sa do vtedajšieho baru Insomnia v Župčanoch. Sedeli sme, smiali sa, rozoberali život a všetko možné, keď z vedľajšieho stola sa ozvalo:<br>
<b>„Baby, nepripijeme si spolu?“</b><br>
Pozrela som tým smerom a tam sedel veľmi sympatický a pekný chalan – Jakub. Už som ho trošku poznala ako kamoša mojej sestry a pamätám si, že som jej raz povedala: „Ten chalan je  velmi pekný!“ Takže keď sa k nám chcel pridať, ja som neprotestovala – práve naopak, tešila som sa.                 </p>
                                                
                                                  <p>Večer sa niesol v znamení smiechu, rozhovorov a postupne sme si padli do oka. No a ako to už býva, noc sa neskončila len vínom a rečami – ocitli sme sa spolu na parkete v bare Aqua Belly a tancovali sme pri akváriu plnom rybičiek. </p>
<p>Ráno bolo mierne trápne. Teda aspoň pre mňa. Trošku som sa hanbila, čakala som, čo bude ďalej. A potom, okolo obeda, mi od Jakuba prišla správa:<br>
<b>„Ahoj, žiješ?“</b>
                                                                <p>
Odvtedy sme si začali písať každý deň. Do konca sviatkov sme sa ešte párkrát stretli a jedného večera mi Jakub povedal vetu, ktorú som vtedy brala len ako žart:
„Ja za tebou prídem do Írska.“
No a on to fakt urobil.                </p>
<p>Po pár mesiacoch naozaj prišiel. A odvtedy je po mojom boku. Môj Jakub z neba. </p>
            </div>

                <h4 class="col-md-12 text-center" class="header"><strong>Príbeh podľa Kuba</strong></h4>
                <p>
December 2019, pekné vianky ale ja zničený vysokou školou, pretože som získal ultimátny vysokoškolský úspech DVD - Do Vianoc Doma, nafurt.
                </p>

                                <p>
Prešiel štedrý deň, prišlo 25. decembra a keďže som bol nezamestnaný a v podstate neštudent, vybral som sa s partiou do Župčanskej krčmičky. A tam hľa, pri vedľajšom stole pekná blondínka, popíja fernet s kolou a užíva si Vianočnú dovolenku.
Slovo dalo slovo a už sme sedeli pri jednom stole, vymienali historky a plnili krčmovú kasičku. Ale Lenka za pár dni odchádzala do Írska. Ale keďže máme úžasnú dobu mesendžeru a mal som kopec voľného času, nonstop sme si písali.
V marci prišla Lenka na dovolenku, veď ma predsa chcela vidieť :) Vtedy som jej povedal, že za ňou prídem do Írska, Lenka sa zasmiala a ja som začal kuť plány do budúcnosti. 
                </p>
                                                <p>
Šetril som a priplazil sa november, kúpil som letenky, pobalil tých 7 tričiek ktoré som mal, pokýval som a hurá za novým dobrodružstvom. Keďže tam Lenka žila aj s Paťou a Simonou, hľadali sme nové väčšie bývanie, prvé dni sme spali na matraci a užívali život. 
Ledva som si našiel robotu a zrazu korona. A znova sme si užívali, čo to šlo. Jedná vlna, druhá vlna, tretia vlna, medzitým po roku a pol nezáživná robota a mne zrazu začalo niečo chýbať (asi slnko, keďže vo Februári 2021 len pršalo a pršalo).
Pocit, že to chce znova zmenu, chcem ísť späť na VŠ. Lenka neváhala ani sekundu, hovorí že ide somnou, najsamlepšie rozhodnutie <span class="fa fa-heart pulse2"></span>. 
                </p>
                                                                <p>
Ďalšie roky boli plné driny a zážitkov, samostatné bývanie, prerábka nášho skromného príbytku, nespočet osláv, skúškové, výlety, hádky, no proste All Inclusive.  Kto mal na začiatku tušiť, že o 6 rokov bude vešeľe?
                </p>
            </div>
            <div class="col-md-3 hidden-sm hidden-xs"><img src="img/IMG_cropped_tog2.png" class="wp2"></div>
        </div>
        <div class="row">
            <div class="col-sm-4 col-sm-push-2 col-xs-6 hidden-md hidden-lg"><img src="img/IMG_cropped_tog1.jpg" class="wp8"></div>

            <!-- <div class="col-sm-4 col-sm-push-2 col-xs-6 hidden-md hidden-lg"><img src="img/IMG_2317.jpg" class="wp8"></div> -->
            <div class="col-sm-4 col-sm-push-2 col-xs-6 hidden-md hidden-lg"><img src="img/IMG_cropped_tog2.png" class="wp9"></div>
        </div>
    </div>
</section>

<!-- TODO celu tuto sekciu vymysliet! -->
<section class="events section-padding" id="events">
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <h3 class="header">Events</h3>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6 col-sm-12 col-xs-12 leftcol">
                <div class="wp3">
                    <p><strong>22 August</strong></p>

                    <h5>Obrad <span class="time"> 14:30 - 15:30</span></h5>
                    <p>Tu si povieme svoje áno &#129505</p>
                </div>
            </div>
            <div class="col-md-6 col-sm-12 col-xs-12 leftcol">
                <div class="wp3">
                    <h5>Teleportácia <span class="time"> 15:30 - 16:30</span></h5>
                    <p>Smer Stodolienka u Hricka, Hanušovce nad Topľou</p>
                </div>
            </div>
            <div class="col-md-6 col-sm-12 col-xs-12 leftcol">
                <div class="wp4">
                    <h5>Hostina <span class="time"> 16:30 - 03:00</span></h5>
                    <p>Papanie a oslavovanie</p>
                    <div class="tenor-gif-embed" data-postid="14307475070394584011" data-share-method="host" data-aspect-ratio="0.564171" data-width="100%"><a href="https://tenor.com/view/cat-dancing-to-party-rock-anthem-gif-14307475070394584011">Cat Dancing To Party Rock Anthem GIF</a>from <a href="https://tenor.com/search/cat+dancing+to+party+rock+anthem-gifs">Cat Dancing To Party Rock Anthem GIFs</a></div> <script type="text/javascript" async src="https://tenor.com/embed.js"></script>
                </div>
            </div>
        </div>

    </div>
</section>

<footer>
    <div class="container">
        <div class="row">
            <div class="col-sm-12 text-center content">
                <span class="to-top-wrapper"><a href="#top" class="to-top"><i class="fa fa-angle-up"></i></a></span>
                <p>Crafted by Kubko with lots of <span class="fa fa-heart pulse2"></span> for Lenka</p>
            </div>
        </div>
    </div>
</footer>
<script src="js/vendor/jquery-1.11.2.min.js" onerror="loadJsFromCDN('jquery.js')"></script>
<script src="node_modules/waypoints/lib/jquery.waypoints.min.js" onerror="loadJsFromCDN('waypoints.js')"></script>
<script src="js/jquery.fancybox.pack.js"></script>
<script src="js/vendor/bootstrap.min.js"></script>
<script src="js/jquery.flexslider-min.js"></script>
<script src="js/jquery.mb.YTPlayer.min.js"></script>
<script src="js/vendor/ouical.js"></script>
<script src="js/scripts.min.js"></script>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
  import { SUPABASE_URL, ANON_KEY, BUCKET, EXCHANGE_FN } from "./js/app-config.js";

  // --- Zdieľaný helper: vyžiadanie krátkodobého JWT cez tvoj exchange-token
  let supabaseJwt = null;

  async function getJwtClient(forceRefresh = false) {
    if (supabaseJwt && !forceRefresh) return supabaseJwt;

    const supabasePublic = createClient(SUPABASE_URL, ANON_KEY);

    const params  = new URLSearchParams(location.search);
    const qrToken = params.get("token");
    if (!qrToken) {
      throw new Error("Chýba prístupový token – oskenuj QR kód.");
    }

    // DÔLEŽITÉ: token posielame v query stringu (ako už používaš inde)
    const { data, error } = await supabasePublic.functions.invoke(
      `exchange-token?token=${encodeURIComponent(qrToken)}`
    );
    if (error || !data?.access_token) {
      throw new Error(error?.message || "Token exchange failed");
    }

    supabaseJwt = createClient(SUPABASE_URL, ANON_KEY, {
      global: { headers: { Authorization: `Bearer ${data.access_token}` } }
    });
    return supabaseJwt;
  }

  // --- DOM prvky
  const form    = document.getElementById("odkazForm");
  const nameEl  = document.getElementById("odkazName");
  const msgEl   = document.getElementById("odkazMessage");
  const counter = document.getElementById("odkazCounter");
  const status  = document.getElementById("odkazStatus");
  const btn     = document.getElementById("odkazSubmit");

  // --- UX: live počítadlo znakov + zapni/vypni tlačidlo
  const LIMIT = 10000;
  function updateCounter() {
    const len = (msgEl.value || "").length;
    counter.textContent = `${len} / ${LIMIT}`;
    if (len === 0 || len > LIMIT) {
      btn.setAttribute("disabled", "");
    } else {
      btn.removeAttribute("disabled");
    }
  }
  msgEl.addEventListener("input", updateCounter);
  updateCounter();

  function setStatus(text, ok = true) {
    status.textContent = text;
    status.style.color = ok ? "#2e7d32" : "#c62828";
  }

  // --- Submit handler
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    setStatus("");

    const name    = (nameEl.value || "").trim();
    const message = (msgEl.value || "").trim();

    if (!message) {
      setStatus("Napíš prosím odkaz 😊", false);
      return;
    }
    if (message.length > LIMIT) {
      setStatus("Odkaz je príliš dlhý (max. 10 000 znakov).", false);
      return;
    }

    btn.setAttribute("disabled", "");
    setStatus("Odosielam…");

    // Zabaliť volanie na edge funkciu + 1x retry pri expirovanom JWT
    async function callSubmit(client) {
      return client.functions.invoke("submit-odkaz", { body: { name, message } });
    }

    try {
      let client = await getJwtClient();
      let { data, error } = await callSubmit(client);

      // Ak by JWT medzitým expiroval → obnov a skús znova
      if ((error && (error.status === 401 || error.status === 403)) || (data && data.error === "JWT expired")) {
        client = await getJwtClient(true);
        ({ data, error } = await callSubmit(client));
      }

      if (error || data?.error) {
        setStatus(data?.error || error?.message || "Nepodarilo sa odoslať odkaz.", false);
        return;
      }

      // Úspech
      setStatus("✅ Ďakujeme!");
      form.reset();
      updateCounter();

      // BONUS UX: predvyplň meno nabudúce (lokálne)
      if (name) {
        try { localStorage.setItem("odkaz_name", name); } catch {}
      }
    } catch (err) {
      console.error(err);
      setStatus("Chyba pri odosielaní. Skús to prosím znova.", false);
    } finally {
      btn.removeAttribute("disabled");
    }
  });

  // Predvyplň meno, ak sme si ho uložili
  try {
    const saved = localStorage.getItem("odkaz_name");
    if (saved) { nameEl.value = saved; }
  } catch {}
</script>


</body>
</html>



